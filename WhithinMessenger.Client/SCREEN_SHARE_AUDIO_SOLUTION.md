# üéØ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —ç—Ö–∞ –ø—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ —Å –∞—É–¥–∏–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–ª—ã—à–∞–ª–∏ **—ç—Ö–æ** - —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ–ª–æ—Å–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞.

### –ü—Ä–∏—á–∏–Ω–∞:
`getDisplayMedia()` –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫**, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç:
- ‚úÖ –ó–≤—É–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–≥—Ä–∞, –≤–∏–¥–µ–æ)
- ‚ùå –ì–æ–ª–æ—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí **–°–û–ó–î–ê–Å–¢ –≠–•–û**

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: MediaDevices API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ constraints

### –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞:

```javascript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    displaySurface: 'window' // –Ø–≤–Ω–æ –ø—Ä–æ—Å–∏–º –æ–∫–Ω–æ (–Ω–µ –º–æ–Ω–∏—Ç–æ—Ä)
  },
  audio: {
    // –ö–õ–Æ–ß–ï–í–û–ï: –ò–∑–æ–ª—è—Ü–∏—è –∞—É–¥–∏–æ
    suppressLocalAudioPlayback: true, // –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    
    // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
    displaySurface: 'window',   // –ê—É–¥–∏–æ –¢–û–õ–¨–ö–û –∏–∑ –æ–∫–Ω–∞
    logicalSurface: true,        // –ë–µ–∑ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–≤—É–∫–æ–≤
    systemAudio: 'exclude',      // –ù–ï –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
    echoCancellation: false,
    noiseSuppression: false,
    autoGainControl: false
  },
  
  // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∞–º –±—Ä–∞—É–∑–µ—Ä
  selfBrowserSurface: 'exclude',
  systemAudio: 'exclude'
});
```

---

## üé® –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1Ô∏è‚É£ **–í–∫–ª–∞–¥–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (Browser Tab)** üü¢
```
‚úÖ –õ–£–ß–®–ò–ô –í–ê–†–ò–ê–ù–¢
suppressLocalAudioPlayback = true
‚Üí –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –≥–æ–ª–æ—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
‚Üí –ù–ï–¢ –≠–•–ê!
```

### 2Ô∏è‚É£ **–û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Window)** üü°
```
üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–æ–ª—è—Ü–∏—é:
  - –ï—Å–ª–∏ deviceId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –ê—É–¥–∏–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ
  - –ï—Å–ª–∏ deviceId –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫ ‚ö†Ô∏è
  
üí° –û—Å—Ç–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∏—Ç
```

### 3Ô∏è‚É£ **–í–µ—Å—å –º–æ–Ω–∏—Ç–æ—Ä (Monitor)** üî¥
```
‚ùå –í–°–ï–ì–î–ê –°–ò–°–¢–ï–ú–ù–´–ô –ó–í–£–ö
‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ
‚Üí –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤—ã–±—Ä–∞—Ç—å –æ–∫–Ω–æ –∏–ª–∏ –≤–∫–ª–∞–¥–∫—É
```

---

## üìä –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∞

–ü–æ—Å–ª–µ –∑–∞—Ö–≤–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º:

```javascript
const audioSettings = audioTrack.getSettings();

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
const isBrowserTab = videoSettings.displaySurface === 'browser';
const isWindow = videoSettings.displaySurface === 'window';
const isMonitor = videoSettings.displaySurface === 'monitor';

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–æ–ª—è—Ü–∏—é
const isIsolated = (isBrowserTab && audioSettings.suppressLocalAudioPlayback) 
                || (isWindow && !audioSettings.deviceId);

// –†–µ—à–µ–Ω–∏–µ:
if (isMonitor) {
  // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–æ–≤
  audioTrack.stop();
  stream.removeTrack(audioTrack);
} else if (isBrowserTab && !hasSuppression) {
  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –æ –≤–æ–∑–º–æ–∂–Ω–æ–º —ç—Ö–µ
  console.warn('Update browser for better echo suppression');
}
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ–º **–¢–û–õ–¨–ö–û –Ω–∞—Ç–∏–≤–Ω—ã–µ API –±—Ä–∞—É–∑–µ—Ä–∞**
- –ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö Worklet –∏–ª–∏ Web Audio API
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### ‚úÖ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- –†–∞–±–æ—Ç–∞–µ—Ç –≤ **Chrome, Edge, Firefox**
- –ë—Ä–∞—É–∑–µ—Ä —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–ª—è—Ü–∏–µ–π –∞—É–¥–∏–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- –ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU

---

## üîß –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. `callStore.js` - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ constraints –≤ `getDisplayMedia()`
- –î–æ–±–∞–≤–ª–µ–Ω –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∞—É–¥–∏–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–æ–≤

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** 
```
WhithinMessenger.Client/src/shared/lib/stores/callStore.js
startScreenShare() - —Å—Ç—Ä–æ–∫–∏ 1549-1692
```

---

## üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ –∑–≤—É–∫–æ–º:

#### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: –í–∫–ª–∞–¥–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (–õ–£–ß–®–ò–ô)
1. –ù–∞–∂–∞—Ç—å "–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞"
2. –í—ã–±—Ä–∞—Ç—å **"–í–∫–ª–∞–¥–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞"**
3. –í–∫–ª—é—á–∏—Ç—å **"–¢—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏"**
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ó–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ –ë–ï–ó –≥–æ–ª–æ—Å–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚úÖ

#### üü° –í–∞—Ä–∏–∞–Ω—Ç 2: –û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
1. –ù–∞–∂–∞—Ç—å "–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞"
2. –í—ã–±—Ä–∞—Ç—å **"–û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–≥—Ä–∞)
3. –í–∫–ª—é—á–∏—Ç—å **"–¢—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫"**
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ó–≤—É–∫ –∏–≥—Ä—ã, **–≤–æ–∑–º–æ–∂–Ω–æ** —Å –≥–æ–ª–æ—Å–∞–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
5. **–ï—Å–ª–∏ —Å–ª—ã—à–Ω–æ —ç—Ö–æ:** –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤—ã–±—Ä–∞—Ç—å –≤–∫–ª–∞–¥–∫—É

#### ‚ùå –í–∞—Ä–∏–∞–Ω—Ç 3: –í–µ—Å—å —ç–∫—Ä–∞–Ω (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
- –ê—É–¥–∏–æ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è**
- –ü—Ä–∏—á–∏–Ω–∞: –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–Å —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∞—É–¥–∏–æ ‚Üí –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —ç—Ö–æ
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í—ã–±—Ä–∞—Ç—å –æ–∫–Ω–æ –∏–ª–∏ –≤–∫–ª–∞–¥–∫—É

---

## üöÄ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏

| –ë—Ä–∞—É–∑–µ—Ä | –í–µ—Ä—Å–∏—è | `suppressLocalAudioPlayback` | `systemAudio: exclude` |
|---------|--------|------------------------------|------------------------|
| Chrome  | 94+    | ‚úÖ –î–∞                         | ‚úÖ –î–∞ (105+)            |
| Edge    | 94+    | ‚úÖ –î–∞                         | ‚úÖ –î–∞ (105+)            |
| Firefox | 113+   | ‚úÖ –î–∞                         | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ            |
| Safari  | 17+    | ‚ùå –ù–µ—Ç                        | ‚ùå –ù–µ—Ç                 |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Chrome/Edge 105+ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏:

```javascript
// 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞
// 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:

// –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
üîä Audio track settings: {
  displaySurface: "browser" | "window" | "monitor",
  suppressLocalAudioPlayback: true,
  deviceId: undefined (–¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ)
}

üìä Audio source analysis: {
  type: "browser",
  isIsolated: true
}

// –î–ª—è –≤–∫–ª–∞–¥–∫–∏:
‚úÖ Browser Tab + suppressLocalAudioPlayback = NO ECHO! üéâ

// –î–ª—è –æ–∫–Ω–∞:
‚úÖ Window audio appears isolated (no deviceId)

// –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∞:
‚ö†Ô∏è MONITOR sharing detected!
üîá Removing audio to prevent echo
```

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏** –ø—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å –∞—É–¥–∏–æ
2. **–í—ã–±–∏—Ä–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –±—Ä–∞—É–∑–µ—Ä–∞** –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏
3. **–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä** –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
1. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ `audioSettings.deviceId` - –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é
2. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `suppressLocalAudioPlayback` –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
3. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∏ –û–°

---

## ‚ú® –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ MediaDevices API** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∞—É–¥–∏–æ:
- ‚úÖ –ü—Ä–æ—Å—Ç–æ
- ‚úÖ –ù–∞–¥—ë–∂–Ω–æ
- ‚úÖ –ë—ã—Å—Ç—Ä–æ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö

**–≠—Ö–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ** –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞! üéâ

