# Архитектура системы глобальных звонков

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                        App.jsx                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 AppProviders                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │              CallProvider                          │   │ │
│  │  │  ┌─────────────────────────────────────────────┐   │   │ │
│  │  │  │           GlobalCallManager                 │   │   │ │
│  │  │  │  ┌─────────────────────────────────────┐   │   │   │ │
│  │  │  │  │         ActiveCallBar               │   │   │   │ │
│  │  │  │  └─────────────────────────────────────┘   │   │   │ │
│  │  │  └─────────────────────────────────────────────┘   │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Слои архитектуры

### 1. Слой данных (Zustand Store)
```
┌─────────────────────────────────────────────────────────────────┐
│                    callStore.js                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Состояние                              │   │
│  │  • isConnected: boolean                               │   │
│  │  • isInCall: boolean                                 │   │
│  │  • participants: Array                                │   │
│  │  • isMuted: boolean                                   │   │
│  │  • userVolumes: Map                                   │   │
│  │  • WebRTC соединения                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Действия                               │   │
│  │  • initializeCall()                                   │   │
│  │  • joinRoom()                                         │   │
│  │  • endCall()                                          │   │
│  │  • toggleMute()                                       │   │
│  │  • toggleGlobalAudio()                                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Слой контекста (React Context)
```
┌─────────────────────────────────────────────────────────────────┐
│                    CallContext.jsx                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 CallProvider                            │   │
│  │  • Оборачивает приложение                              │   │
│  │  • Предоставляет глобальный доступ                     │   │
│  │  • Обрабатывает инициализацию                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 useCall Hook                           │   │
│  │  • Возвращает состояние и методы                      │   │
│  │  • Обрабатывает ошибки                                │   │
│  │  • Управляет жизненным циклом                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Слой хуков (Abstraction Layer)
```
┌─────────────────────────────────────────────────────────────────┐
│                   useGlobalCall.js                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Упрощенный API                         │   │
│  │  • startCall(roomId, roomName)                        │   │
│  │  • endCall()                                          │   │
│  │  • isCallActive                                       │   │
│  │  • getCallInfo()                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Интеграция с Auth                      │   │
│  │  • Автоматическое подключение                         │   │
│  │  • Проверка прав доступа                              │   │
│  │  • Управление пользователем                           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 4. Слой компонентов (UI Layer)
```
┌─────────────────────────────────────────────────────────────────┐
│                    UI Components                               │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              GlobalCallManager                          │   │
│  │  • Рендерит ActiveCallBar                              │   │
│  │  • Глобальное управление                               │   │
│  │  • Интеграция с приложением                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                ActiveCallBar                           │   │
│  │  • Отображается поверх всех страниц                    │   │
│  │  • Содержит элементы управления                        │   │
│  │  • Показывает участников                               │   │
│  │  • Адаптивный дизайн                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  CallButton                             │   │
│  │  • Инициация/завершение звонков                        │   │
│  │  • Адаптивные размеры                                  │   │
│  │  • Различные стили                                     │   │
│  │  • Интеграция в компоненты                             │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Инициация звонка
```
User clicks CallButton
         ↓
useGlobalCall.startCall()
         ↓
CallContext.initializeCall()
         ↓
callStore.initializeCall()
         ↓
voiceCallApi.connect()
         ↓
WebRTC connection established
         ↓
ActiveCallBar appears
```

### 2. Управление звонком
```
User interacts with ActiveCallBar
         ↓
useGlobalCall.toggleMute()
         ↓
CallContext.toggleMute()
         ↓
callStore.toggleMute()
         ↓
WebRTC track.enabled = !isMuted
         ↓
UI updates automatically
```

### 3. Завершение звонка
```
User clicks end call
         ↓
useGlobalCall.endCall()
         ↓
CallContext.endCall()
         ↓
callStore.endCall()
         ↓
WebRTC connections closed
         ↓
ActiveCallBar disappears
```

## Интеграция с существующей системой

### 1. Voice Call API
```
┌─────────────────────────────────────────────────────────────────┐
│                Existing Voice Call API                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              voiceCallApi.js                           │   │
│  │  • WebRTC соединения                                   │   │
│  │  • Mediasoup интеграция                                │   │
│  │  • Socket.io события                                   │   │
│  │  • Шумоподавление                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Аутентификация
```
┌─────────────────────────────────────────────────────────────────┐
│                    Auth System                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                AuthContext                              │   │
│  │  • Управление пользователем                            │   │
│  │  • Проверка прав доступа                               │   │
│  │  • Интеграция с API                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Преимущества архитектуры

### 1. Разделение ответственности
- **Store**: Управление состоянием и WebRTC
- **Context**: React интеграция
- **Hooks**: Упрощенный API
- **Components**: UI представление

### 2. Непрерывность звонков
- WebRTC соединения хранятся глобально
- Состояние сохраняется между навигацией
- Компоненты могут размонтироваться без потери звонка

### 3. Масштабируемость
- Легко добавлять новые функции
- Модульная архитектура
- Переиспользование компонентов

### 4. Производительность
- Zustand оптимизирован для производительности
- Селективные обновления
- Минимальные перерендеры

## Безопасность и надежность

### 1. Обработка ошибок
```
┌─────────────────────────────────────────────────────────────────┐
│                Error Handling                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Store Level                               │   │
│  │  • try/catch блоки                                     │   │
│  │  • Валидация входных данных                            │   │
│  │  • Graceful degradation                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Component Level                           │   │
│  │  • Error boundaries                                    │   │
│  │  │  • Fallback UI                                      │   │
│  │  │  • Пользовательские сообщения                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Очистка ресурсов
```
┌─────────────────────────────────────────────────────────────────┐
│                Resource Cleanup                                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              WebRTC Cleanup                            │   │
│  │  • Закрытие соединений                                 │   │
│  │  • Остановка треков                                    │   │
│  │  • Освобождение памяти                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Event Listeners                           │   │
│  │  • Удаление обработчиков                               │   │
│  │  • Очистка таймеров                                     │   │
│  │  • Отписка от событий                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Мониторинг и отладка

### 1. Логирование
- Детальные логи в development режиме
- Структурированные сообщения
- Трассировка вызовов функций

### 2. Метрики
- Время подключения
- Качество соединения
- Количество участников
- Ошибки и их частота

### 3. Отладка
- DevTools интеграция
- Состояние store в реальном времени
- Визуализация потока данных
